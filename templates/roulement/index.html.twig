{% extends 'base.html.twig' %}

{% block title %}Tableau Planning{% endblock %}

{% block body %}

<div class="flex flex-col justify-center items-center p-6">

    {% if is_granted('ROLE_ADMIN') %}
        <div class="flex flex-col justify-between items-center p-2 w-full">    
            <div class="flex justify-between items-center p-2 gap-4 w-full">
                <div></div>
                <a href="{{ path('app_user_index') }}"><i class="fa-solid fa-gears text-3xl"></i></a>
            </div>
        </div>
    {% endif %}

    {% if is_granted('ROLE_PLANNING') %}
        <div class="flex flex-col justify-between items-center p-2 w-full">    
            <div class="flex justify-between items-center p-2 gap-4 w-full mb-6">
                <div></div>
                <a href="{{ path('app_logout') }}" class="text-xl"><i class="fa-solid fa-arrow-right-from-bracket"></i></a>
            </div>
        </div>
    {% endif %}

    <div class="flex justify-between items-center p-2 gap-4 w-full mb-6">

        {# =============== Jour férié ============== #}
        <div class="flex flex-col gap-2 bg-orange-200 p-4 rounded-xl">

            <p class="font-bold undeline text-orange-600 text-lg text-center mb-2 pb-2 border-b-2 border-b-orange-600">Jours fériés du mois</p>

            {# <ul>
                {% for day in ferie %}
                    {% if day.date|date('m') == "now"|date('m') %}
                        <li class="font-bold">{{ day.label }} ({{ day.date|date('d/m') }})</li>
                    {% endif %}
                {% endfor %}
            </ul> #}
            <ul>
            {# {{ dump(ferie) }} #}
                {% for day in ferie %}
                    {% if day.date|date('m') == "may"|date('m') %}
                        <li class="font-bold">{{ day.service.label }} ({{ day.date|date('d/m') }})</li>
                    {% endif %}
                {% endfor %}
            </ul>
        </div>

        <form action="#" method="get" class="w-3/6">
            <label class="input input-bordered flex items-center gap-2">
                <input type="text" id="search" name="search" value="{{ searchTerm }}" class="grow" placeholder="Rechercher un utilisateur" />
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" fill="currentColor" class="w-4 h-4 opacity-70"><path fill-rule="evenodd" d="M9.965 11.026a5 5 0 1 1 1.06-1.06l2.755 2.754a.75.75 0 1 1-1.06 1.06l-2.755-2.754ZM10.5 7a3.5 3.5 0 1 1-7 0 3.5 3.5 0 0 1 7 0Z" clip-rule="evenodd" /></svg>
            </label>
        </form>
    </div>

    {# ============== FORMAT ET TRI DATES ============== #}
    {% set dates = [] %}  
    {% set datesFormatted = [] %}  
    {% set dayTraduction = {'Monday': 'Lundi', 'Tuesday': 'Mardi', 'Wednesday': 'Mercredi', 'Thursday': 'Jeudi', 'Friday': 'Vendredi', 'Saturday': 'Samedi', 'Sunday': 'Dimanche'} %}
   
    {% for user in users %}
        {% for roulement in user.roulements %}
            {% if roulement.date|date('d-m-Y') not in dates %}
                {% set dates = dates|merge([roulement.date|date('d-m-Y')]) %}
            {% endif %}        
        {% endfor %}
    {% endfor %}
    
    {% for day in dates %}
        {% set datesFormatted = datesFormatted|merge([date(day)]) %}
    {% endfor %}

    {% set dateSorted = datesFormatted|sort %}
    {% set lastSevenDay = dateSorted|slice(-7) %}

    {# ================= TABLE ================== #}
    <table class="table">
        <thead>
            <tr class="text-center bg-gray-800 text-white">
                <th></th>
                {% for day in lastSevenDay %}
                    <th class="uppercase text-base">
                        <div>
                            <p>{{ dayTraduction[day|date('l')] }}</p>
                            <p>{{ day|date('d/m') }}</p>
                        </div>
                    </th>
                {% endfor %}
            </tr>
        </thead>
        {% for user in users %}
        <tbody class="">
            {% if user.roulements|length > 0 %}
                <tr class="border-y-2 bg-gray-50 hover:bg-gray-200">
                    <td class="w-1/3 font-bold text-slate-950 border-r-2">{{ user.username }}</td>
                    {% for day in lastSevenDay %}
                        <td class="border-r-2 px-2 py-1">
                            {% for roulement in user.roulements %}
                                {% if roulement.date == day %}
                                    <div class="text-center text-lg">
                                        {% if roulement.service.label|slice(-1) != 'S' and roulement.service.label|slice(-1) != 'M'%}
                                            <p class="bg-gray-600 font-bold text-white">{{ roulement.MatinSoir }}</p>
                                        {% else %}
                                            <p class="bg-gray-600 font-bold text-white">{{ roulement.service.label }}</p>
                                        {% endif %}
                                        <p class="bg-gray-300">{{ roulement.priseDeService|date('H:i')}}</p>
                                        <p class="bg-gray-300">{{ roulement.finDeService|date('H:i')}}</p>
                                    </div>
                                {% endif %}
                            {% endfor %}
                        </td>  
                    {% endfor %}
                </tr>
            {% endif %}
        {% else %}
            <tr>
                <td colspan="6">Aucun utilisateur correspondant</td>
            </tr>
        {% endfor %}
        </tbody>
    </table>
</div>
{% endblock %}
